<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>AgroMath MVP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <div class="topbar">
    <div class="container row space">
      <div class="brand">
        <div class="logo">A</div>
        <div>
          <div class="brandname">AgroMath</div>
          <div class="tag">Farm â†’ City logistics, MVP</div>
        </div>
      </div>

      <div class="nav">
        {% if session.get("uid") %}
          <a class="navlink" href="/dashboard">Dashboard</a>
          <a class="navlink" href="/orders">Orders</a>
          <a class="navlink" href="/profile">Profile</a>

          <!-- Phase 1 UX controls -->
          <button id="themeToggle" class="navbtn" type="button" title="Switch theme">Theme</button>
          <button id="soundToggle" class="navbtn" type="button" title="Toggle notification sound">Sound: Off</button>

          <a class="navlink" href="/logout">Logout</a>
        {% else %}
          <a class="navlink" href="/login">Login</a>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="container">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flashwrap">
          {% for cat, msg in messages %}
            <div class="flash {{ cat }}">{{ msg }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}
  </div>

  <!-- Phase 1 notifications: in-app polling + unique sound -->
  {% if session.get("uid") %}
    <div id="agroToast" class="toast" style="display:none"></div>
    <audio id="agroNotifySound" preload="auto">
      <source src="{{ url_for('static', filename='notify.wav') }}" type="audio/wav">
    </audio>
    <script>
      (function(){
        const toast = document.getElementById('agroToast');
        const sound = document.getElementById('agroNotifySound');
        const keyLast = 'agro_last_notif_id';
        const keySound = 'agro_sound_enabled';
        const keyTheme = 'agro_theme';

        const btnTheme = document.getElementById('themeToggle');
        const btnSound = document.getElementById('soundToggle');

        function getLast(){
          const v = localStorage.getItem(keyLast);
          const n = parseInt(v || '0', 10);
          return isNaN(n) ? 0 : n;
        }
        function setLast(id){ localStorage.setItem(keyLast, String(id||0)); }
        function soundEnabled(){
          const v = localStorage.getItem(keySound);
          // default ON, but user can switch OFF
          return v === null ? true : (v === 'true');
        }

        function getTheme(){
          const v = localStorage.getItem(keyTheme);
          return v || 'bright';
        }
        function setTheme(t){
          localStorage.setItem(keyTheme, t);
          document.documentElement.dataset.theme = t;
          updateButtons();
        }

        function updateButtons(){
          if (btnTheme){
            const t = getTheme();
            btnTheme.textContent = (t === 'dark') ? 'Theme: Dark' : 'Theme: Bright';
          }
          if (btnSound){
            btnSound.textContent = soundEnabled() ? 'ðŸ”” Sound: On' : 'ðŸ”• Sound: Off';
          }
        }

        // Apply theme as early as possible
        document.documentElement.dataset.theme = getTheme();

        function showToast(message, link){
          toast.innerHTML = '';
          const box = document.createElement('div');
          box.className = 'toast-inner';
          const text = document.createElement('div');
          text.className = 'toast-text';
          text.textContent = message;
          box.appendChild(text);

          if (link){
            const a = document.createElement('a');
            a.className = 'toast-link';
            a.href = link;
            a.textContent = 'Open';
            box.appendChild(a);
          }

          const btn = document.createElement('button');
          btn.className = 'toast-close';
          btn.type = 'button';
          btn.textContent = 'Ã—';
          btn.onclick = () => { toast.style.display='none'; };
          box.appendChild(btn);

          toast.appendChild(box);
          toast.style.display = 'block';

          // auto-hide
          setTimeout(()=>{ toast.style.display='none'; }, 6000);
        }

        async function unlockSound(){
          // Browsers often block audio until the user interacts.
          // A click on our toggle counts as a gesture; we use it to â€œunlockâ€ playback.
          try {
            sound.currentTime = 0;
            await sound.play();
            sound.pause();
            sound.currentTime = 0;
          } catch (e) {
            // If it's still blocked, we keep silent. User can try again.
          }
        }

        async function poll(){
          try {
            const since = getLast();
            const res = await fetch('/api/notifications?since=' + encodeURIComponent(since), {cache:'no-store'});
            if (!res.ok) return;
            const data = await res.json();
            if (data && data.latest_id !== undefined){
              setLast(data.latest_id);
            }
            if (data && data.items && data.items.length){
              const first = data.items[0];
              if (soundEnabled()){
                try { sound.currentTime = 0; await sound.play(); } catch(e) {
                  // browser may block until user interacts
                }
              }
              showToast(first.message, first.link);
            }
          } catch (e) {
            // silent: polling shouldn't break the UI
          }
        }

        // Start polling
        setTimeout(poll, 1500);
        setInterval(poll, 10000);

        // Wire up buttons (if user is logged in)
        if (btnTheme){
          btnTheme.addEventListener('click', ()=>{
            setTheme(getTheme() === 'dark' ? 'bright' : 'dark');
          });
        }
        if (btnSound){
          btnSound.addEventListener('click', async ()=>{
            const next = !soundEnabled();
            localStorage.setItem(keySound, String(next));
            updateButtons();
            if (next){
              await unlockSound();
              showToast('Sound enabled. You will hear a â€œmarket bellâ€ on new updates.', '');
            } else {
              showToast('Sound disabled.', '');
            }
          });
        }

        // Optional: quick toggle via keyboard (Shift+N)
        document.addEventListener('keydown', (e)=>{
          if (e.shiftKey && (e.key === 'N' || e.key === 'n')){
            localStorage.setItem(keySound, String(!soundEnabled()));
            updateButtons();
            showToast('Notification sound: ' + (soundEnabled() ? 'ON' : 'OFF'), '');
          }
        });

        updateButtons();
      })();
    </script>
  {% endif %}

  <div class="footer">
    <div class="container muted small">
      Built for testing. No payments, no SMS, no escrow (yet).
    </div>
  </div>
</body>
</html>
