<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>AgroMath MVP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <div class="topbar">
    <div class="container row space">
      <div class="brand">
        <div class="logo">A</div>
        <div>
          <div class="brandname">AgroMath</div>
          <div class="tag">Farm â†’ City logistics, MVP</div>
        </div>
      </div>

      <div class="nav">
        {% if session.get("uid") %}
          <a class="navlink" href="/dashboard">Dashboard</a>
          <a class="navlink" href="/orders">Orders</a>
          <a class="navlink" href="/profile">Profile</a>
          <a class="navlink" href="/logout">Logout</a>
        {% else %}
          <a class="navlink" href="/login">Login</a>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="container">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flashwrap">
          {% for cat, msg in messages %}
            <div class="flash {{ cat }}">{{ msg }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}
  </div>

  <!-- Phase 1 notifications: in-app polling + unique sound -->
  {% if session.get("uid") %}
    <div id="agroToast" class="toast" style="display:none"></div>
    <audio id="agroNotifySound" preload="auto">
      <source src="{{ url_for('static', filename='notify.wav') }}" type="audio/wav">
    </audio>
    <script>
      (function(){
        const toast = document.getElementById('agroToast');
        const sound = document.getElementById('agroNotifySound');
        const keyLast = 'agro_last_notif_id';
        const keySound = 'agro_sound_enabled';

        function getLast(){
          const v = localStorage.getItem(keyLast);
          const n = parseInt(v || '0', 10);
          return isNaN(n) ? 0 : n;
        }
        function setLast(id){ localStorage.setItem(keyLast, String(id||0)); }
        function soundEnabled(){
          const v = localStorage.getItem(keySound);
          return v === null ? true : (v === 'true');
        }

        function showToast(message, link){
          toast.innerHTML = '';
          const box = document.createElement('div');
          box.className = 'toast-inner';
          const text = document.createElement('div');
          text.className = 'toast-text';
          text.textContent = message;
          box.appendChild(text);

          if (link){
            const a = document.createElement('a');
            a.className = 'toast-link';
            a.href = link;
            a.textContent = 'Open';
            box.appendChild(a);
          }

          const btn = document.createElement('button');
          btn.className = 'toast-close';
          btn.type = 'button';
          btn.textContent = 'Ã—';
          btn.onclick = () => { toast.style.display='none'; };
          box.appendChild(btn);

          toast.appendChild(box);
          toast.style.display = 'block';

          // auto-hide
          setTimeout(()=>{ toast.style.display='none'; }, 6000);
        }

        async function poll(){
          try {
            const since = getLast();
            const res = await fetch('/api/notifications?since=' + encodeURIComponent(since), {cache:'no-store'});
            if (!res.ok) return;
            const data = await res.json();
            if (data && data.latest_id !== undefined){
              setLast(data.latest_id);
            }
            if (data && data.items && data.items.length){
              const first = data.items[0];
              if (soundEnabled()){
                try { await sound.play(); } catch(e) { /* browser may block until user interacts */ }
              }
              showToast(first.message, first.link);
            }
          } catch (e) {
            // silent: polling shouldn't break the UI
          }
        }

        // Start polling
        setTimeout(poll, 1500);
        setInterval(poll, 10000);

        // Optional: quick toggle via keyboard (Shift+N)
        document.addEventListener('keydown', (e)=>{
          if (e.shiftKey && (e.key === 'N' || e.key === 'n')){
            localStorage.setItem(keySound, String(!soundEnabled()));
            showToast('Notification sound: ' + (soundEnabled() ? 'ON' : 'OFF'), '');
          }
        });
      })();
    </script>
  {% endif %}

  <div class="footer">
    <div class="container muted small">
      Built for testing. No payments, no SMS, no escrow (yet).
    </div>
  </div>
<audio id="notifAudio" preload="auto"><source src="/static/cowbell.wav" type="audio/wav"></audio>
<script>
(function(){
  const audioEl = document.getElementById("notifAudio");
  const soundBtn = document.getElementById("soundBtn");
  const notifBtn = document.getElementById("notifBtn");

  // Sound enable: browsers require a user gesture before audio playback works.
  function setSoundEnabled(v){
    localStorage.setItem("agro_sound", v ? "1" : "0");
    if(soundBtn){
      soundBtn.textContent = v ? "ðŸ””" : "ðŸ”ˆ";
      soundBtn.title = v ? "Sound: on" : "Sound: off";
    }
  }
  function isSoundEnabled(){ return localStorage.getItem("agro_sound") === "1"; }

  async function unlockAudio(){
    if(!audioEl) return;
    try{
      audioEl.volume = 0.6;
      // play+pause quickly to satisfy gesture requirement
      await audioEl.play();
      audioEl.pause();
      audioEl.currentTime = 0;
      return true;
    }catch(e){
      return false;
    }
  }

  async function beep(){
    if(!audioEl || !isSoundEnabled()) return;
    try{
      audioEl.currentTime = 0;
      await audioEl.play();
    }catch(e){
      // Autoplay blocked; disable sound until user re-enables
      setSoundEnabled(false);
    }
  }

  // Web Notifications (in-browser). Optional.
  async function ensureNotificationPermission(){
    if(!("Notification" in window)) return false;
    if(Notification.permission === "granted") return true;
    if(Notification.permission === "denied") return false;
    const p = await Notification.requestPermission();
    return p === "granted";
  }

  function showToast(msg){
    // lightweight toast
    const t = document.createElement("div");
    t.className = "toast";
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(()=>t.classList.add("show"), 20);
    setTimeout(()=>{ t.classList.remove("show"); setTimeout(()=>t.remove(), 300); }, 3500);
  }

  function showDesktopNotification(title, body){
    if(!("Notification" in window)) return;
    if(Notification.permission !== "granted") return;
    try{ new Notification(title, { body }); }catch(e){}
  }

  if(soundBtn){
    // initialize
    setSoundEnabled(isSoundEnabled());
    soundBtn.addEventListener("click", async ()=>{
      const next = !isSoundEnabled();
      if(next){
        const ok = await unlockAudio();
        if(!ok){
          showToast("Tap again to enable sound (browser is blocking audio).");
          return;
        }
      }
      setSoundEnabled(next);
      showToast(next ? "Sound enabled" : "Sound disabled");
    });
  }

  if(notifBtn){
    notifBtn.addEventListener("click", async ()=>{
      const ok = await ensureNotificationPermission();
      showToast(ok ? "Browser notifications enabled" : "Browser notifications not enabled");
    });
  }

  let since = Number(localStorage.getItem("agro_notif_since") || "0");

  async function pollNotifications(){
    try{
      const r = await fetch(`/api/notifications?since=${since}`, { cache: "no-store" });
      if(!r.ok) return;
      const data = await r.json();
      if(!data || !data.items) return;
      if(data.items.length){
        // update since to last id
        since = data.items[data.items.length-1].id;
        localStorage.setItem("agro_notif_since", String(since));

        // play sound once per batch
        await beep();

        // show toast + desktop
        const last = data.items[data.items.length-1];
        showToast(last.message || "New update");
        showDesktopNotification("AgroMath", last.message || "New update");
      }
    }catch(e){
      // ignore
    }
  }

  // Poll every 8 seconds (lightweight)
  setInterval(pollNotifications, 8000);
})();
</script>
</body>
</html>
