{% extends "base.html" %}
{% block content %}

<div class="row space">
  <div>
    <h2>Buyer Dashboard</h2>
    <div class="muted">
      Welcome{% if user.name %}, {{ user.name }}{% endif %}. Search products, add items, then checkout and place an order.
    </div>
  </div>
  <div class="pillrow">
    <a class="btn btn-ghost" href="/checkout">Cart ({{ cart_count }})</a>
    <a class="btn btn-ghost" href="/orders">Orders</a>
    <a class="btn btn-light" href="/profile">Profile</a>
  </div>
</div>

<div class="card">
  <div class="row space" style="gap:12px; align-items:end;">
    <form method="get" action="/buyer" class="row" style="gap:10px; flex-wrap:wrap; align-items:end;">
      <div>
        <div class="muted small">Search</div>
        <input class="input" type="text" name="q" value="{{ q or '' }}" placeholder="Search products (e.g., beans)" style="min-width:240px;">
      </div>

      <div>
        <div class="muted small">Sort</div>
        <select class="input" name="sort">
          <option value="newest" {% if sort=='newest' %}selected{% endif %}>Newest</option>
          <option value="nearest" {% if sort=='nearest' %}selected{% endif %}>Nearest</option>
          <option value="price_asc" {% if sort=='price_asc' %}selected{% endif %}>Price (low → high)</option>
          <option value="price_desc" {% if sort=='price_desc' %}selected{% endif %}>Price (high → low)</option>
        </select>
      </div>

      <div>
        <div class="muted small">Radius</div>
        <select class="input" name="radius_km">
          <option value="" {% if radius_km is none %}selected{% endif %}>Any</option>
          {% for r in [2,5,10,20,50] %}
            <option value="{{ r }}" {% if radius_km is not none and (radius_km|float) == (r|float) %}selected{% endif %}>Within {{ r }} km</option>
          {% endfor %}
        </select>
      </div>

      <button class="btn btn-primary" type="submit">Apply</button>
      <a class="btn btn-ghost" href="/buyer">Reset</a>
    </form>

    <div style="text-align:right;">
      <div class="muted small">Near Me</div>
      <div class="row" style="gap:8px; justify-content:flex-end;">
        <button class="btn btn-light" type="button" onclick="setNearMe()">Use my current location</button>
        <button class="btn btn-ghost" type="button" onclick="clearNearMe()" {% if not has_buyer_loc %}disabled{% endif %}>Clear</button>
      </div>
      <div class="muted small" style="margin-top:6px;">
        {% if has_buyer_loc %}
          Location set. Nearest/radius filters will work.
        {% else %}
          Set your location to enable “Nearest” and radius filtering.
        {% endif %}
      </div>
    </div>
  </div>

  <hr>

  {% if groups and groups|length > 0 %}
    {% for g in groups %}
      <div class="card" style="margin-bottom:14px;">
        <div class="row space" style="align-items:center;">
          <div>
            <div class="strong">{{ g.farmer_name or "Farmer" }}</div>
            <div class="muted small">Pickup: {{ g.farmer_hub or "Not set" }}</div>
          </div>
          <div>
            {% if g.distance_km is not none %}
              <div class="pill muted small">{{ "%.1f"|format(g.distance_km) }} km away</div>
            {% endif %}
          </div>
        </div>

        <div class="grid" style="margin-top:10px;">
          {% for p in g.products %}
            <div class="card mini">
              <div class="strong">{{ p.name }} <span class="muted small">({{ p.unit }})</span></div>
              <div style="margin-top:10px;"><b>{{ money(p.price) }}</b></div>
              <div style="margin-top:10px;">
                <form method="post" action="/cart/add" class="row" style="gap:8px;">
                  <input type="hidden" name="product_id" value="{{ p.id }}">
                  <input class="qty" name="qty" type="number" min="1" value="1" style="width:90px">
                  <button class="btn btn-primary" type="submit">Add</button>
                </form>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endfor %}
  {% else %}
    <p class="muted">No matching products found.</p>
  {% endif %}
</div>

<script>
async function setNearMe() {
  if (!navigator.geolocation) {
    alert("Geolocation is not supported on this device/browser.");
    return;
  }
  navigator.geolocation.getCurrentPosition(async (pos) => {
    const payload = { lat: pos.coords.latitude, lng: pos.coords.longitude };
    try {
      const res = await fetch("/buyer/location", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || "Unable to set location.");
      // Refresh to apply nearest/radius
      window.location.reload();
    } catch (e) {
      alert(e.message || "Unable to set location.");
    }
  }, (err) => {
    alert("Unable to read location. Please enable GPS/location permission and try again.");
  }, { enableHighAccuracy: true, timeout: 15000 });
}

async function clearNearMe() {
  try {
    const res = await fetch("/buyer/location/clear", { method: "POST" });
    const data = await res.json();
    if (!data.ok) throw new Error("Unable to clear location.");
    window.location.reload();
  } catch (e) {
    alert("Unable to clear location.");
  }
}
</script>

{% endblock %}
