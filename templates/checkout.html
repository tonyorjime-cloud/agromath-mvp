{% extends "base.html" %}
{% block content %}

<div class="row space">
  <div>
    <h2>Checkout</h2>
    <div class="muted">Confirm your cart, then place the order (transport quotes come later).</div>
  </div>
  <div class="pillrow">
    <a class="btn btn-ghost" href="/buyer">Back to products</a>
    <a class="btn btn-ghost" href="/orders">Orders</a>
  </div>
</div>

<div class="grid2">
  <div class="card">
    <h3>Cart Items</h3>

    {% if items %}
      <div class="table">
        <div class="thead">
          <div>Item</div><div>Farmer</div><div>Qty</div><div>Unit</div><div>Line</div><div></div>
        </div>
        {% for it in items %}
          <div class="trow">
            <div class="strong">{{ it.product.name }}</div>
            <div class="muted">{{ it.product.farmer_name or "—" }}</div>
            <div>{{ it.qty }}</div>
            <div>{{ money(it.product.price) }}</div>
            <div><b>{{ money(it.line_total) }}</b></div>
            <div>
              <form method="post" action="/cart/remove" class="inline">
                <input type="hidden" name="product_id" value="{{ it.product.id }}">
                <button class="btn btn-light" type="submit">Remove</button>
              </form>
            </div>
          </div>
        {% endfor %}
      </div>

      <div class="spacer"></div>
      <div class="summary">
        <div class="sumrow"><span>Subtotal</span><b>{{ money(subtotal) }}</b></div>
      </div>

    {% else %}
      <p class="muted">Your cart is empty.</p>
    {% endif %}
  </div>

  <div class="card">
    <h3>Place Order</h3>
    <form method="post" action="/order/place" class="stack">
      <label class="label">Origin (pickup)</label>
      <input id="originText" name="origin" placeholder="e.g., Makurdi Hub" required>

      <div class="row" style="justify-content:space-between;gap:10px;">
        <button type="button" class="btn btn-ghost" id="btnUseGps">Use my current location</button>
        <div class="muted small" id="gpsOriginStatus"></div>
      </div>

      <input type="hidden" name="origin_lat" id="origin_lat">
      <input type="hidden" name="origin_lng" id="origin_lng">
      <input type="hidden" name="origin_accuracy" id="origin_accuracy">
      <label class="label">Destination</label>
      <input name="dest" placeholder="e.g., Abuja" required>
      <button class="btn btn-primary" type="submit" {% if not items %}disabled{% endif %}>Place Order</button>
    </form>

    <p class="muted small">After placing the order, transporters will submit quotes. You can accept or decline.</p>
  </div>
</div>


<script>
(function(){
  const btn = document.getElementById('btnUseGps');
  const statusEl = document.getElementById('gpsOriginStatus');
  const latEl = document.getElementById('origin_lat');
  const lngEl = document.getElementById('origin_lng');
  const accEl = document.getElementById('origin_accuracy');
  const originText = document.getElementById('originText');

  if(!btn) return;

  btn.addEventListener('click', function(){
    if(!navigator.geolocation){
      statusEl.textContent = 'Geolocation not supported.';
      return;
    }
    statusEl.textContent = 'Requesting permission…';
    navigator.geolocation.getCurrentPosition(
      function(p){
        const lat = p.coords.latitude;
        const lng = p.coords.longitude;
        const acc = p.coords.accuracy;

        latEl.value = String(lat);
        lngEl.value = String(lng);
        accEl.value = String(acc || '');

        if(!originText.value.trim()){
          originText.value = 'Current Location';
        }

        statusEl.textContent = `Captured (±${Math.round(acc||0)}m)`;
      },
      function(err){
        statusEl.textContent = 'Location error: ' + err.message;
      },
      {enableHighAccuracy:true, maximumAge:60000, timeout:15000}
    );
  });
})();
</script>

{% endblock %}
