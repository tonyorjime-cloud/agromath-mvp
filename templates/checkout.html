{% extends "base.html" %}
{% block content %}

<div class="row space">
  <div>
    <h2>Checkout</h2>
    <div class="muted">Confirm your cart, then place the order (transport quotes come later).</div>
  </div>
  <div class="pillrow">
    <a class="btn btn-ghost" href="/buyer">Back to products</a>
    <a class="btn btn-ghost" href="/orders">Orders</a>
  </div>
</div>

<div class="grid2">
  <div class="card">
    <h3>Cart Items</h3>

    {% if items %}
      <div class="table">
        <div class="thead">
          <div>Item</div><div>Farmer</div><div>Qty</div><div>Unit</div><div>Line</div><div></div>
        </div>
        {% for it in items %}
          <div class="trow">
            <div class="strong">{{ it.product.name }}</div>
            <div class="muted">{{ it.product.farmer_name or "—" }}</div>
            <div>{{ it.qty }}</div>
            <div>{{ money(it.product.price) }}</div>
            <div><b>{{ money(it.line_total) }}</b></div>
            <div>
              <form method="post" action="/cart/remove" class="inline">
                <input type="hidden" name="product_id" value="{{ it.product.id }}">
                <button class="btn btn-light" type="submit">Remove</button>
              </form>
            </div>
          </div>
        {% endfor %}
      </div>

      <div class="spacer"></div>
      <div class="summary">
        <div class="sumrow"><span>Subtotal</span><b>{{ money(subtotal) }}</b></div>
      </div>

    {% else %}
      <p class="muted">Your cart is empty.</p>
    {% endif %}
  </div>

  <div class="card">
    <h3>Place Order</h3>
    <form method="post" action="/order/place" class="stack">
      <label class="label">Origin (pickup)</label>
      <input id="originText" name="origin" placeholder="e.g., Makurdi Hub" required>

      <div class="row" style="justify-content:space-between;gap:10px;">
        <button type="button" class="btn btn-ghost" id="btnUseGps">Use my current location</button>
        <div class="muted small" id="gpsOriginStatus"></div>
      </div>

      <input type="hidden" name="origin_lat" id="origin_lat">
      <input type="hidden" name="origin_lng" id="origin_lng">
      <input type="hidden" name="origin_accuracy" id="origin_accuracy">
      <label class="label">Destination (buyer drop-off)</label>
      <input id="destText" name="dest" placeholder="e.g., Wuse 2, Abuja" required>

      <div class="row" style="justify-content:space-between;gap:10px;">
        <button type="button" class="btn btn-ghost" id="btnUseGpsDest">Use my current location</button>
        <div class="muted small" id="gpsDestStatus"></div>
      </div>

      <input type="hidden" name="dest_lat" id="dest_lat">
      <input type="hidden" name="dest_lng" id="dest_lng">
      <input type="hidden" name="dest_accuracy" id="dest_accuracy">
      <button class="btn btn-primary" type="submit" {% if not items %}disabled{% endif %}>Place Order</button>
    </form>

    <p class="muted small">After placing the order, transporters will submit quotes. You can accept or decline.</p>
  </div>
</div>


<script>
(function(){
  function bindGps(btnId, statusId, latId, lngId, accId, textId){
    const btn = document.getElementById(btnId);
    const statusEl = document.getElementById(statusId);
    const latEl = document.getElementById(latId);
    const lngEl = document.getElementById(lngId);
    const accEl = document.getElementById(accId);
    const textEl = document.getElementById(textId);

    if(!btn) return;

    btn.addEventListener('click', function(){
      if(!navigator.geolocation){
        statusEl.textContent = 'Geolocation not supported.';
        return;
      }
      statusEl.textContent = 'Requesting permission…';
      navigator.geolocation.getCurrentPosition(
        function(p){
          const lat = p.coords.latitude;
          const lng = p.coords.longitude;
          const acc = p.coords.accuracy;

          latEl.value = String(lat);
          lngEl.value = String(lng);
          accEl.value = String(acc || '');

          if(textEl && !textEl.value.trim()){
            textEl.value = 'Current Location';
          }

          statusEl.textContent = `Captured (±${Math.round(acc||0)}m)`;
        },
        function(err){
          statusEl.textContent = 'Location error: ' + err.message;
        },
        {enableHighAccuracy:true, maximumAge:60000, timeout:15000}
      );
    });
  }

  // Origin (pickup)
  bindGps('btnUseGps', 'gpsOriginStatus', 'origin_lat', 'origin_lng', 'origin_accuracy', 'originText');

  // Destination (drop-off)
  bindGps('btnUseGpsDest', 'gpsDestStatus', 'dest_lat', 'dest_lng', 'dest_accuracy', 'destText');
})();
</script>

{% endblock %}
