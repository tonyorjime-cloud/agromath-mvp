{% extends "base.html" %}
{% block content %}

<div class="row space">
  <div>
    <h2>Orders</h2>
    <div class="muted">Buyer: accept/decline quotes. Transporter: quote open orders. Farmer: view relevant orders.</div>
  </div>
  <div class="pillrow">
    {% if user.role == 'buyer' %}
      <a class="btn btn-ghost" href="/buyer">Products</a>
      <a class="btn btn-ghost" href="/checkout">Checkout</a>
    {% elif user.role == 'farmer' %}
      <a class="btn btn-ghost" href="/farmer">Dashboard</a>
    {% elif user.role == 'transporter' %}
      <a class="btn btn-ghost" href="/transport">Dashboard</a>
    {% endif %}
    <a class="btn btn-light" href="/profile">Profile</a>
  </div>
</div>

<div class="card">
  {% if orders %}
    <div class="orders">
      {% for pack in orders %}
        {% set o = pack.order %}
        <div class="order-card">
          <div class="row">
            <div>
              <div class="strong">{{ o.id }}</div>
              <div class="muted small">{{ o.origin }} → {{ o.dest }} · {{ o.created_at }}</div>
            </div>
            <div class="status">{{ o.status }}</div>
            <div>
              <a class="btn btn-ghost" href="/track/{{ o.id }}">Track</a>
              <a class="btn btn-ghost" href="/chat/{{ o.id }}">Chat</a>
            </div>
          </div>

          <div class="spacer"></div>

          <div class="muted small strong">Items</div>
          <ul class="list">
            {% for it in pack.line_items %}
              <li>{{ it.product_name }} ({{ it.qty }} {{ it.product_unit }}) — {{ it.farmer_name }}</li>
            {% endfor %}
          </ul>

          {% if user.role == 'farmer' and o.status == 'PENDING_PICKUP' %}
            <div class="spacer"></div>
            <div class="muted small strong">Confirm pickup location (required before transporters can quote)</div>
            <form method="post" action="/farmer/pickup" class="stack" style="max-width:520px;">
              <input type="hidden" name="order_id" value="{{ o.id }}">
              <label class="label">Pickup (farm / store / hub)</label>
              <input id="pickupText-{{ o.id }}" name="origin" placeholder="e.g., Kuje Farm Gate" required>
              <div class="row" style="justify-content:space-between;gap:10px;">
                <button type="button" class="btn btn-ghost btnPickupGps" data-oid="{{ o.id }}">Use my current location</button>
                <div class="muted small" id="pickupGpsStatus-{{ o.id }}"></div>
              </div>
              <input type="hidden" name="origin_lat" id="pickup_lat-{{ o.id }}">
              <input type="hidden" name="origin_lng" id="pickup_lng-{{ o.id }}">
              <input type="hidden" name="origin_accuracy" id="pickup_accuracy-{{ o.id }}">
              <button class="btn btn-primary" type="submit">Confirm pickup</button>
            </form>
          {% endif %}

          <div class="spacer"></div>

          <div class="muted small strong">Transport quotes</div>

          {% if pack.quotes %}
            <div class="table">
              <div class="thead">
                <div>Transporter</div><div>Price</div><div>ETA</div><div>Status</div>
                {% if user.role == 'buyer' and o.status == 'NEEDS_QUOTES' %}<div>Action</div>{% endif %}
              </div>

              {% for q in pack.quotes %}
                <div class="trow">
                  <div>{{ q.transporter_name or q.transporter_phone }}</div>
                  <div><b>{{ money(q.price) }}</b></div>
                  <div class="muted">{{ q.eta_hours }} hrs</div>
                  <div class="muted small">{{ q.status }}</div>

                  {% if user.role == 'buyer' and o.status == 'NEEDS_QUOTES' %}
                    <div>
                      {% if q.status == 'SUBMITTED' %}
                        <form method="post" action="/quote/accept" class="inline">
                          <input type="hidden" name="order_id" value="{{ o.id }}">
                          <input type="hidden" name="quote_id" value="{{ q.id }}">
                          <button class="btn btn-primary" type="submit">Accept</button>
                        </form>

                        <form method="post" action="/quote/decline" class="inline">
                          <input type="hidden" name="order_id" value="{{ o.id }}">
                          <input type="hidden" name="quote_id" value="{{ q.id }}">
                          <button class="btn btn-light" type="submit">Decline</button>
                        </form>
                      {% else %}
                        <span class="muted small">—</span>
                      {% endif %}
                    </div>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p class="muted">No quotes yet.</p>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p class="muted">No orders yet.</p>
  {% endif %}
</div>



<script>
(function(){
  function bind(){
    document.querySelectorAll('.btnPickupGps').forEach(btn => {
      btn.addEventListener('click', function(){
        const oid = btn.getAttribute('data-oid');
        const statusEl = document.getElementById('pickupGpsStatus-' + oid);
        const latEl = document.getElementById('pickup_lat-' + oid);
        const lngEl = document.getElementById('pickup_lng-' + oid);
        const accEl = document.getElementById('pickup_accuracy-' + oid);
        const textEl = document.getElementById('pickupText-' + oid);

        if(!navigator.geolocation){
          statusEl.textContent = 'Geolocation not supported.';
          return;
        }
        statusEl.textContent = 'Requesting permission…';
        navigator.geolocation.getCurrentPosition(
          function(p){
            latEl.value = String(p.coords.latitude);
            lngEl.value = String(p.coords.longitude);
            accEl.value = String(p.coords.accuracy || '');
            if(!textEl.value.trim()) textEl.value = 'Current Location';
            statusEl.textContent = `Captured (±${Math.round(p.coords.accuracy||0)}m)`;
          },
          function(err){
            statusEl.textContent = 'Location error: ' + err.message;
          },
          {enableHighAccuracy:true, maximumAge:60000, timeout:15000}
        );
      });
    });
  }
  bind();
})();
</script>

{% endblock %}
