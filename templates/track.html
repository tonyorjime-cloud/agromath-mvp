{% extends "base.html" %}
{% block content %}
<div class="row space">
  <div>
    <h2>Live Tracking</h2>
    <div class="muted">Order {{ order_id }} · Status: {{ status }}</div>
  </div>
  <div class="pillrow">
    <a class="btn btn-ghost" href="/orders">Back to Orders</a>
    {% if user.role == 'transporter' %}
      <button class="btn btn-light" id="navPickupBtn" type="button">Navigate to Pickup</button>
      <button class="btn btn-primary" id="navDropoffBtn" type="button">Navigate to Buyer</button>
    {% endif %}
  </div>
</div>

<div class="card">
  <div class="muted small">
    {% if user.role == 'transporter' %}
      Share your live location so the buyer can track delivery.
    {% else %}
      Buyer view: you'll see the transporter's last known location once they share it.
    {% endif %}
  </div>

  <div class="spacer"></div>

  {% if user.role == 'transporter' %}
    {% if not assigned %}
      <div class="muted small">Location sharing activates only after the buyer accepts your quote for this order.</div>
      <div class="spacer"></div>
    {% endif %}
    <div class="row">
      <button class="btn btn-primary" id="gpsStart" type="button" {% if not assigned %}disabled{% endif %}>Start sharing location</button>
      <button class="btn btn-light" id="gpsStop" type="button" disabled>Stop</button>
      <div class="muted small" id="gpsStatus" style="margin-left:10px;">Not sharing yet.</div>
    </div>
    <div class="spacer"></div>
  {% endif %}

  <div id="map" style="height:420px; border-radius:14px; overflow:hidden;"></div>

  <div class="spacer"></div>
  <div class="muted small" id="trackInfo">Waiting for location…</div>
</div>

<!-- Leaflet for maps (no install needed) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
(function(){
  const orderId = "{{ order_id }}";
  const role = "{{ user.role }}";
  const orderStatus = "{{ status }}";
  let lastBuyer = null;

  // map init (Abuja-ish default)
  const map = L.map('map').setView([9.06, 7.49], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

  let originMarker = null;
  let buyerMarker = null;
  let transporterMarker = null;

  function setMarker(kind, loc){
    if(!loc) return;
    const lat = loc.lat, lng = loc.lng;
    if(kind === 'origin'){
      if(!originMarker) originMarker = L.marker([lat,lng]).addTo(map).bindPopup('Pickup');
      originMarker.setLatLng([lat,lng]);
    } else if(kind === 'buyer'){
      if(!buyerMarker) buyerMarker = L.marker([lat,lng]).addTo(map).bindPopup('Drop-off');
      buyerMarker.setLatLng([lat,lng]);
    } else {
      if(!transporterMarker) transporterMarker = L.marker([lat,lng]).addTo(map).bindPopup('Transporter');
      transporterMarker.setLatLng([lat,lng]);
    }
  }

  async function refresh(){
    try{
      const r = await fetch(`/api/order/${orderId}/track`, {headers:{'Accept':'application/json'}});
      const j = await r.json();
      if(!j.ok){
        document.getElementById('trackInfo').textContent = j.error || 'Not available';
        return;
      }
      lastBuyer = j.buyer || null;
      window.__lastOrigin = j.origin || null;
      setMarker('origin', j.origin);
      setMarker('buyer', j.buyer);
      setMarker('transporter', j.transporter);

      // fit bounds when we have at least transporter
      const pts = [];
      if(j.origin) pts.push([j.origin.lat, j.origin.lng]);
      if(j.buyer) pts.push([j.buyer.lat, j.buyer.lng]);
      if(j.transporter) pts.push([j.transporter.lat, j.transporter.lng]);
      if(pts.length){
        map.fitBounds(pts, {padding:[30,30]});
      }
      const t = j.transporter ? `Transporter: ${j.transporter.lat.toFixed(5)}, ${j.transporter.lng.toFixed(5)} (${j.transporter.created_at})` : 'Transporter has not shared location yet.';
      document.getElementById('trackInfo').textContent = t;
    }catch(e){
      document.getElementById('trackInfo').textContent = 'Refresh failed (network).';
    }
  }

  refresh();
  setInterval(refresh, 10000); // 10s poll

  // Navigation gating: drop-off navigation becomes primary after pickup is confirmed.
  if(role === 'transporter'){
    const dropBtn = document.getElementById('navDropoffBtn');
    if(dropBtn){
      if(orderStatus === 'EN_ROUTE_TO_PICKUP' || orderStatus === 'QUOTE_ACCEPTED'){
        dropBtn.classList.add('btn-light');
        dropBtn.classList.remove('btn-primary');
      }
    }
  }

  // One-tap Google Maps navigation (pickup first, then drop-off).
  if(role === 'transporter'){
    const pickupBtn = document.getElementById('navPickupBtn');
    const dropBtn = document.getElementById('navDropoffBtn');

    function openDir(dest){
      const url = `https://www.google.com/maps/dir/?api=1&destination=${dest.lat},${dest.lng}&travelmode=driving`;
      window.open(url, '_blank');
    }

    if(pickupBtn){
      pickupBtn.addEventListener('click', function(){
        // pickup = origin
        if(!window.__lastOrigin){
          alert('Pickup GPS not available yet.');
          return;
        }
        openDir(window.__lastOrigin);
      });
    }

    if(dropBtn){
      dropBtn.addEventListener('click', function(){
        if(!lastBuyer){
          alert('Buyer destination GPS not available yet.');
          return;
        }
        openDir(lastBuyer);
      });
    }
  }

  // If transporter, hook up GPS buttons using browser geolocation.
  if(role === 'transporter'){
    let watchId = null;

    const startBtn = document.getElementById('gpsStart');
    const stopBtn = document.getElementById('gpsStop');
    const statusEl = document.getElementById('gpsStatus');

    function setState(running){
      startBtn.disabled = running;
      stopBtn.disabled = !running;
    }

    async function postLoc(p){
      const payload = {
        lat: p.coords.latitude,
        lng: p.coords.longitude,
        accuracy: p.coords.accuracy
      };
      try{
        await fetch(`/api/order/${orderId}/location`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        statusEl.textContent = `Sharing… accuracy ${Math.round(payload.accuracy||0)}m`;
      }catch(e){
        statusEl.textContent = 'Sharing… but post failed (network).';
      }
    }

    startBtn.addEventListener('click', function(){
      if(!navigator.geolocation){
        statusEl.textContent = 'Geolocation not supported on this browser.';
        return;
      }
      setState(true);
      statusEl.textContent = 'Requesting permission…';
      watchId = navigator.geolocation.watchPosition(
        postLoc,
        function(err){
          statusEl.textContent = 'Location error: ' + err.message;
          setState(false);
        },
        {enableHighAccuracy:true, maximumAge:10000, timeout:15000}
      );
    });

    stopBtn.addEventListener('click', function(){
      if(watchId !== null && navigator.geolocation){
        navigator.geolocation.clearWatch(watchId);
      }
      watchId = null;
      setState(false);
      statusEl.textContent = 'Stopped.';
    });
  }
})();
</script>
{% endblock %}
