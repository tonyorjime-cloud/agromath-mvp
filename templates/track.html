{% extends "base.html" %}
{% block content %}
<div class="row space">
  <div>
    <h2>Live Tracking</h2>
    <div class="muted">Order {{ order_id }} · Status: {{ status }}</div>
  </div>
  <div class="pillrow">
    <a class="btn btn-ghost" href="/orders">Back to Orders</a>
  </div>
</div>

<div class="card">
  <div class="muted small">
    {% if user.role == 'transporter' %}
      Share your live location so the buyer can track delivery.
    {% else %}
      Buyer view: you'll see the transporter's last known location once they share it.
    {% endif %}
  </div>

  <div class="spacer"></div>

  {% if user.role == 'transporter' %}
    <div class="row">
      <button class="btn btn-primary" id="gpsStart" type="button">Start sharing location</button>
      <button class="btn btn-light" id="gpsStop" type="button" disabled>Stop</button>
      <div class="muted small" id="gpsStatus" style="margin-left:10px;">Not sharing yet.</div>
    </div>
    <div class="spacer"></div>
  {% endif %}

  <div id="map" style="height:420px; border-radius:14px; overflow:hidden;"></div>

  <div class="spacer"></div>
  <div class="muted small" id="trackInfo">Waiting for location…</div>
</div>

<!-- Leaflet for maps (no install needed) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
(function(){
  const orderId = "{{ order_id }}";
  const role = "{{ user.role }}";

  const map = L.map('map').setView([9.06, 7.49], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

  let buyerMarker = null;
  let farmerMarker = null;
  let transporterMarker = null;
  let routeLine = null;

  function upsertMarker(kind, loc){
    if(!loc) return;
    const lat = loc.lat, lng = loc.lng;
    if(kind === 'buyer'){
      if(!buyerMarker) buyerMarker = L.marker([lat,lng]).addTo(map).bindPopup('Buyer (Drop-off)');
      buyerMarker.setLatLng([lat,lng]);
    } else if(kind === 'farmer'){
      if(!farmerMarker) farmerMarker = L.marker([lat,lng]).addTo(map).bindPopup('Farmer (Pickup)');
      farmerMarker.setLatLng([lat,lng]);
    } else {
      if(!transporterMarker) transporterMarker = L.marker([lat,lng]).addTo(map).bindPopup('Transporter');
      transporterMarker.setLatLng([lat,lng]);
    }
  }

  function upsertLine(pickup, dropoff){
    if(!pickup || !dropoff) return;
    const pts = [[pickup.lat, pickup.lng],[dropoff.lat, dropoff.lng]];
    if(!routeLine){
      routeLine = L.polyline(pts).addTo(map);
    } else {
      routeLine.setLatLngs(pts);
    }
  }

  async function refresh(){
    try{
      const r = await fetch(`/api/order/${orderId}/track`, {headers:{'Accept':'application/json'}});
      const j = await r.json();
      if(!j.ok){
        document.getElementById('trackInfo').textContent = j.error || 'Not available';
        return;
      }
      upsertMarker('buyer', j.buyer);
      upsertMarker('farmer', j.farmer);
      upsertMarker('transporter', j.transporter);
      upsertLine(j.farmer, j.buyer);

      const pts = [];
      if(j.buyer) pts.push([j.buyer.lat, j.buyer.lng]);
      if(j.farmer) pts.push([j.farmer.lat, j.farmer.lng]);
      if(j.transporter) pts.push([j.transporter.lat, j.transporter.lng]);
      if(pts.length){
        map.fitBounds(pts, {padding:[30,30]});
      }

      let info = [];
      if(j.farmer) info.push(`Pickup set (${j.farmer.created_at})`); else info.push('Pickup not set yet.');
      if(j.buyer) info.push(`Drop-off set (${j.buyer.created_at})`); else info.push('Drop-off not set yet.');
      if(j.transporter) info.push(`Transporter: ${j.transporter.lat.toFixed(5)}, ${j.transporter.lng.toFixed(5)} (${j.transporter.created_at})`);
      else info.push('Transporter has not shared location yet.');
      document.getElementById('trackInfo').textContent = info.join(' · ');
    }catch(e){
      document.getElementById('trackInfo').textContent = 'Refresh failed (network).';
    }
  }

  refresh();
  setInterval(refresh, 10000);

  if(role === 'transporter'){
    let watchId = null;
    const startBtn = document.getElementById('gpsStart');
    const stopBtn = document.getElementById('gpsStop');
    const statusEl = document.getElementById('gpsStatus');

    function setState(running){
      startBtn.disabled = running;
      stopBtn.disabled = !running;
    }

    async function enableTracking(){
      try{
        const r = await fetch(`/api/order/${orderId}/tracking/start`, {method:'POST'});
        const j = await r.json();
        if(!j.ok){
          statusEl.textContent = 'Cannot start tracking: ' + (j.error || 'error');
          return false;
        }
        return true;
      }catch(e){
        statusEl.textContent = 'Cannot start tracking (network).';
        return false;
      }
    }

    async function disableTracking(){
      try{ await fetch(`/api/order/${orderId}/tracking/stop`, {method:'POST'}); }catch(e){}
    }

    async function postLoc(p){
      const payload = {lat: p.coords.latitude, lng: p.coords.longitude, accuracy: p.coords.accuracy};
      try{
        await fetch(`/api/order/${orderId}/location`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        statusEl.textContent = `Sharing… accuracy ${Math.round(payload.accuracy||0)}m`;
      }catch(e){
        statusEl.textContent = 'Sharing… but post failed (network).';
      }
    }

    startBtn.addEventListener('click', async function(){
      if(!navigator.geolocation){
        statusEl.textContent = 'Geolocation not supported on this browser.';
        return;
      }
      setState(true);
      statusEl.textContent = 'Enabling tracking…';
      const ok = await enableTracking();
      if(!ok){
        setState(false);
        return;
      }
      statusEl.textContent = 'Requesting permission…';
      watchId = navigator.geolocation.watchPosition(
        postLoc,
        function(err){
          statusEl.textContent = 'Location error: ' + err.message;
          setState(false);
        },
        {enableHighAccuracy:true, maximumAge:10000, timeout:15000}
      );
    });

    stopBtn.addEventListener('click', async function(){
      if(watchId !== null && navigator.geolocation){
        navigator.geolocation.clearWatch(watchId);
      }
      watchId = null;
      await disableTracking();
      setState(false);
      statusEl.textContent = 'Stopped.';
    });
  }
})();
</script>
{% endblock %}
